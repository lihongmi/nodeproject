前奏
一款 Node.js 性能诊断工具，可以非常快速地定位性能问题

作为nodejs开发者,关注代码的执行效率，是非常重要的

大家可以这样想一下
我们的项目执行时间如果从50ms降到5ms,
 理论上QPS就能提升10倍，
也就是说10台服务器能扛住的流量现在1台服务器就搞定了，
而且响应时间更短.成本更低

因此诊断Node.js性能问题是一项必不可少的技能

这里给大家介绍一款性能诊断工具 clinic

在使用clinic前，我们先编写一个简单的web服务
2.

新建clinic项目 
使用vscode打开我们的项目

新建server.js

引入我们的http模块
创建我们的server

监听在3000端口上

启动后打印输出 启动成功

这里我们编写一段有问题的代码
写一个大对象 不断添加属性的函数
随着属性的数量增加 导致对象在内存老生代区域的垃圾回收变慢

用户每次访问我们都返回给客户端 该对象

3.
node server.js 启动我们web服务

curl访问我们的服务

成功输出 对象内容


4.
    接下来全局安装clinic包

    使用clinic doctor -- node server.js 来启动我们的项目
    
    使用压测工具autocannon来测试 -c 100 代表100个并发链接 -d 20 持续测试20s

    ctr+c产生我们的报告

    侦测到一个潜在的时间循环问题
    点击查看详情
    具体的问题是
    内存使用问题
    和事件循环延迟问题


    我们可以看到随着压测请求数量的增加，我们的内存使用也一直在增加

    事件轮训的毫秒数也在增加


    clinic同样也给我们提供了建议

    可能有1个或多个同步操作阻塞了线程
    
    我们可以使用clinic flame火焰图来发现cpu函数的调用

    clinic flame重新启动我们的服务

    重新进行一轮压测

    完成12k次请求 用了20.05s
    100个并发持续测试20s

   


6.
    ctr+c产生我们的报告
    白色长度代表有问题的代码
    我们发现问题出在server.js 当中的newmsg函数








